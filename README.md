# RAG 기반 주식 분석 시스템

RAG(Retrieval-Augmented Generation) 기술을 활용한 고도화된 주식 분석 시스템입니다. **한국 주식과 해외 주식**을 모두 지원하며, **환율 변환 기능**을 통해 통합된 분석 환경을 제공합니다.

## 주요 기능

### 다중 시장 데이터 수집 및 분석
- **한국 주식 데이터 수집** (pykrx 활용) - 종가 기준
- **해외 주식 데이터 수집** (yfinance 활용) - Close 기준
- **실시간 환율 변환** (USD ↔ KRW)
- **통합 통화 표시** (원본 통화, 원화, 달러 선택 가능)

### AI 기반 RAG 분석
- **한국어 특화 임베딩 모델** (jhgan/ko-sroberta-nli)
- **앙상블 검색 시스템** (BM25 + FAISS)
- **고급 LLM 모델** (Llama-3-Korean-Bllossom-8B)
- **지능형 문서 생성 시스템**
  - 일일 가격 동향 분석 (통화별 표시)
  - 기술적 지표 분석
  - 거래량 분석
  - 특별 이벤트 탐지

### 인터랙티브 시각화
- **Plotly 기반 대화형 차트**
- **기술적 지표 대시보드** (4개 차트 동시 표시)
- **캔들스틱 차트 + 볼린저밴드**
- **실시간 지표 모니터링**
- **통화별 차트 표시** (원화/달러 자동 변환)

### 대화형 분석 인터페이스
- **채팅 세션 관리** (신규 생성, 선택, 삭제)
- **자연어 질문-답변 시스템**
- **3가지 분석 유형**:
  - **기본 분석**: 현재 상황 분석 및 매매 타이밍
  - **20일 예측**: 향후 20일간 주가 전망
  - **투자전략**: 리스크 관리 및 포트폴리오 제안
- **예시 질문 템플릿 제공**

### 글로벌 주식 지원
#### 한국 주식
- **730개 이상 종목** 지원
- **인기 종목**: 삼성전자, SK하이닉스, LG디스플레이, NAVER, 카카오 등
- **6자리 종목코드** 입력 (예: 005930)

#### 해외 주식
- **주요 미국 주식** 지원
- **인기 종목**: Apple, Microsoft, Google, Amazon, Tesla, Meta, NVIDIA 등
- **심볼 입력** (예: AAPL, MSFT, GOOGL)

## 실행 방법

### 필수 요구사항
```bash
pip install -r requirements.txt
```

### 환경 설정
> ⚠️ **프롬프트 직접 작성 필요 안내**

이 시스템은 LLM 기반의 RAG(검색 증강 생성) 구조를 사용합니다.  
분석 프롬프트(예: "기본 분석", "20일 예측", "투자전략")는 env.json 파일에 명시적으로 정의하여 사용합니다.  
자동 생성이 아닌, 아래와 같이 프롬프트의 입력 변수와 템플릿을 직접 설계해야 합니다.

```json
{
  "기본 분석": {
    "input_variables": ["stock_name", "query", "context", "current_date", "current_price"],
    "template": "당신은 전문 주식 투자자입니다. 주어진 정보를 바탕으로 정확하고 분석을 제공하세요.\n\n분석 대상: {stock_name}\n기준 날짜: {current_date}\n질문: {query}\n현재 주가: {current_price:,}원\n\n관련 데이터:\n{context}......"
  },
  "20일 예측": {
    "input_variables": ["stock_name", "context", "current_date", "current_price", "date_table", "RSI_14", "MACD", "BB_position"],
    "template": "20일 예측 분석 템플릿..."
  },
  "투자전략": {
    "input_variables": ["stock_name", "query", "context", "current_date", "current_price"],
    "template": "투자전략 분석 템플릿..."
  }
}
```

### 애플리케이션 실행
```bash
streamlit run main.py
```

브라우저에서 `http://localhost:8501`로 접속하여 사용하세요.

## 사용 가이드

### 1. 기본 사용법
1. **사이드바에서 시장 선택** (한국 주식 / 해외 주식)
2. **표시 통화 선택** (원본 통화 / 원화(KRW) / 달러(USD))
3. **종목 선택 방식 선택**:
   - **인기 종목**: 미리 선별된 인기 종목에서 선택
   - **전체 종목**: 전체 종목에서 검색하여 선택
   - **직접 입력**: 종목코드/심볼 직접 입력
4. **데이터 기간 설정** (30-500 영업일)
5. **"데이터 로드" 버튼 클릭**
6. **각 탭에서 분석 확인**

### 2. 주요 탭 설명
- **차트 분석**: 
  - 기술적 지표 대시보드 (가격/이동평균, RSI, MACD, 거래량)
  - 캔들스틱 + 볼린저밴드 차트
  - 표시 기간 선택 (전체/3개월/1개월/2주)
- **AI 분석**: 
  - 자연어 질문-답변 기반 AI 분석
  - 3가지 분석 유형 선택
  - 예시 질문 템플릿 제공
- **기술적 지표**: 
  - 상세 지표 수치 및 신호
  - 추세 지표 vs 모멘텀 지표 비교
  - 종합 기술적 신호 (강세/약세/종합 판단)




### 3. 샘플 종목
#### 한국 주식
- **LG디스플레이** (034220)
- **삼성전자** (005930)
- **SK하이닉스** (000660)
- **NAVER** (035420)
- **카카오** (035720)

#### 해외 주식
- **Apple** (AAPL)
- **Microsoft** (MSFT)
- **Google** (GOOGL)
- **Tesla** (TSLA)
- **NVIDIA** (NVDA)

## 시스템 아키텍처

### 핵심 클래스 구조
- **ChatManager**: 채팅 세션 관리 및 이력 저장
- **StockDataManager**: 한국/해외 주식 데이터 수집 및 환율 변환
- **CurrencyConverter**: 실시간 환율 조회 및 가격 변환
- **TechnicalIndicators**: 20+ 기술적 지표 계산
- **DocumentGenerator**: 분석 문서 생성 (통화별 표시)
- **RAGSystem**: RAG 시스템 구축 (BM25 + FAISS)
- **QueryProcessor**: 쿼리 처리 및 AI 응답 생성
- **ChartManager**: 대화형 차트 시각화 (통화별 표시)

### 데이터 플로우
1. **시장 선택** → 한국(pykrx) 또는 해외(yfinance) 데이터 소스 결정
2. **데이터 수집** → OHLCV 데이터 수집 (종가 vs Close)
3. **환율 변환** → 선택된 통화로 모든 가격 데이터 변환
4. **지표 계산** → 변환된 데이터로 기술적 지표 계산
5. **문서 생성** → 통화 정보를 포함한 분석 문서 생성
6. **RAG 구축** → 임베딩 및 검색 시스템 구축
7. **AI 분석** → 사용자 질문에 대한 AI 답변 생성

## 설정 옵션

### 모델 설정
- **임베딩 모델**: jhgan/ko-sroberta-nli (한국어 특화)
- **LLM 모델**: MLP-KTLim/llama-3-Korean-Bllossom-8B
- **검색 시스템**: BM25 + FAISS 앙상블 (가중치 0.7:0.3)

### 데이터 소스 설정
- **한국 주식**: pykrx (종가 기준)
- **해외 주식**: yfinance (Close 기준)
- **환율 데이터**: yfinance (USDKRW=X)
- **기본 환율**: 1,300원/달러 (API 실패시)

### 기술적 지표 설정
- **SMA**: 5, 10, 20일
- **EMA**: 12, 26일
- **RSI**: 14일
- **MACD**: 12-26-9
- **볼린저밴드**: 20일, 표준편차 2
- **스토캐스틱**: 14일

### 성능 최적화
- **GPU 자동 감지 및 활용**
- **모델 캐싱** (Streamlit cache_resource 활용)
- **환율 캐싱** (1시간 TTL)
- **문서 다양성 확보** (타입별 균형 선택)
- **컨텍스트 길이 제한** (최대 2500자)

## 다국가 지원 기능

### 환율 변환
- **실시간 환율**: yfinance API를 통한 실시간 USD/KRW 환율
- **자동 변환**: 선택한 통화로 모든 가격 데이터 자동 변환
- **차트 표시**: 차트 Y축에 적절한 통화 심볼 표시 (원/달러)
- **AI 분석**: AI 응답에서도 선택된 통화로 가격 표시

### 지원 통화
- **KRW (원화)**: 한국 주식 기본 통화
- **USD (달러)**: 해외 주식 기본 통화
- **원본 통화**: 각 주식의 원래 통화 유지

## 기술적 지표 상세 설명

### 추세 지표 (Trend Indicators)
이동평균선을 통해 주가의 전반적인 방향성을 파악합니다.

- **SMA (Simple Moving Average)**: 지정 기간의 종가 평균
  - 5일선: 단기 추세, 20일선: 중기 추세
  - 주가가 이동평균선 위에 있으면 상승 추세
- **EMA (Exponential Moving Average)**: 최근 데이터에 더 큰 가중치
  - SMA보다 빠른 신호, 단기 변화에 민감

### 모멘텀 지표 (Momentum Indicators)
주가의 상승/하락 강도와 과매수/과매도 상태를 측정합니다.

- **RSI (Relative Strength Index)**: 0-100 범위
  - 30 이하: 과매도 (매수 신호)
  - 70 이상: 과매수 (매도 신호)
- **MACD (Moving Average Convergence Divergence)**:
  - MACD선이 Signal선을 상향 돌파: 매수 신호
  - MACD선이 Signal선을 하향 돌파: 매도 신호
- **스토캐스틱**: 일정 기간 중 현재 가격의 상대적 위치
  - 80 이상: 과매수, 20 이하: 과매도

### 변동성 지표 (Volatility Indicators)
가격 변동성과 지지/저항 수준을 나타냅니다.

- **볼린저 밴드**: 이동평균선 ± (표준편차 × 2)
  - 상단선 근처: 고점 가능성
  - 하단선 근처: 저점 가능성
  - 밴드 확장: 변동성 증가

### 거래량 지표 (Volume Indicators)
시장 참여도와 거래 강도를 측정합니다.

- **거래량 비율**: 현재 거래량 ÷ 평균 거래량
  - 2배 이상: 거래량 급증 (관심 증가)
  - 0.5배 이하: 거래량 부족 (관심 감소)

## 종합 신호 시스템

시스템은 모든 기술적 지표를 종합하여 다음과 같은 신호를 제공합니다:

- **강세 신호 개수**: 매수를 시사하는 지표 수
- **약세 신호 개수**: 매도를 시사하는 지표 수  
- **종합 판단**: 전체 지표의 균형을 고려한 최종 판단

---

**주의사항**: 이 시스템은 투자 참고용이며, 실제 투자 결정은 신중하게 하시기 바랍니다. 모든 투자에는 위험이 따르며, 과거 성과가 미래 수익을 보장하지 않습니다.